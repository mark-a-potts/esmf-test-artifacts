version: 2.1

commands:
  run-meta-testing:
    parameters:
      branch:
        type: string
    steps:
#     - run:
#         name: Checkout Code (esmf-test-scripts)
#         command: git clone --depth 1 https://github.com/mark-a-potts/esmf-test-artifacts.git
      - run:
          name: Checkout Code (esmf-test-artifacts)
#         command: git clone --depth 1 --branch ${CIRCLE_BRANCH} https://github.com/esmf-org/esmf-test-artifacts.git
          command: git clone https://github.com/mark-a-potts/esmf-test-artifacts.git
      - run:
          name: cd to artifacts
#         command: whoami; git config --global user.email "mark.potts@noaa.gov";git config --global user.name "dcv-bot";cd esmf-test-artifacts; git checkout origin/${CIRCLE_BRANCH} develop/${CIRCLE_BRANCH}; git add develop; echo ${CIRCLE_BRANCH}; git commit -a -m'update from ${CIRCLE_BRANCH}'; git push origin main 
          command: git config --global user.email "mark.potts@noaa.gov";git config --global user.name "dcv-bot";cd esmf-test-artifacts; ls; git branch; git branch -r; 
      - run:
          name: add branch
          command: echo ${CIRCLE_BRANCH};git checkout origin/plavac develop/plavac
      - run:
          name: commit changes
          command: git commit -a -m'updates from plavac'
      - run:
          name: push changes
          command: git push origin main
#     - run:
#         name: Install Dependencies
#         command: pip3 install jsonschema unittest-xml-reporting click gitpython requests python-dateutil pytest-shutil
#     - run:
#         name: python-dateutil dependencies
#         command: sudo pip3 install python-dateutil
#     - run: mkdir -p /tmp/artifacts
#     - run:
#         name: Run Meta Testing
#         command: bash esmf-test-artifacts/.circleci/run.sh << parameters.branch >> << parameters.platform >> << parameters.compiler >> << parameters.comm >>
#     - store_test_results:
#         path: /tmp/artifacts/artifact-tests
#     - store_artifacts:
#         path: /tmp/artifacts/etsumm.log
#     - store_artifacts:
#         path: /tmp/artifacts/artifact-tests.out
#     - run:
#         name: Compress XML Test Output
#         command: cd /tmp/artifacts && zip -r artifact-tests.zip artifact-tests
#     - store_artifacts:
#         path: /tmp/artifacts/artifact-tests.zip
#     - run:
#         name: Check for Failures
#         command: bash esmf-test-artifacts/.circleci/check-for-failures.sh

jobs:

  mt-test:
    docker:
      - image: circleci/python
#       auth:
#         username: $ESMF_DOCKER_USERNAME
#         password: $ESMF_DOCKER_PASSWORD
    steps:
      - add_ssh_keys:
          fingerprints:
            - "44:b8:c9:19:2e:ac:e3:89:e3:51:01:25:c3:6c:2a:47"
      - run-meta-testing:
          branch: plavac

# commit-read:
#   docker:
#     - image: circleci/python
#       auth:
#         username: $ESMF_DOCKER_USERNAME
#         password: $ESMF_DOCKER_PASSWORD
#   steps:
#     - checkout
#     - run:
#         name: python-dateutil dependencies
#         command: sudo pip3 install python-dateutil
#     - run:
#         name: Read Commit Log file 
#         command: pwd && cd develop && python3 build_html.py
#     - run:
#         name: Push HTML 
#         command: pwd && bash .circleci/html_push.sh 

workflows:

  run-meta-testing:
    jobs:
      - mt-test:
          name: test


# run-read-commit:
#   jobs:
#     - commit-read
